<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Expenses & Income Management</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Add custom scrollbar styles from original design -->
    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #e5e7eb;
            border-radius: 20px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #d1d5db;
        }
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.3s ease-out forwards;
        }
    </style>

    <!-- Import Map to allow "import" syntax in browser -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>

    <!-- Babel for JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-50/50">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            LayoutDashboard, 
            TrendingUp, 
            TrendingDown, 
            FileText, 
            Settings, 
            Plus, 
            Search, 
            Filter, 
            Download, 
            Trash2, 
            Edit, 
            X, 
            Check, 
            Menu, 
            LogOut,
            Calendar,
            DollarSign,
            Users,
            Briefcase,
            PieChart,
            ArrowRight
        } from 'lucide-react';
        
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            signInWithCustomToken 
        } from 'firebase/auth';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            doc, 
            query, 
            orderBy, 
            onSnapshot, 
            serverTimestamp,
            where
        } from 'firebase/firestore';

        // --- Firebase Configuration & Initialization ---
        // NOTE: Uses global __firebase_config from environment or falls back to placeholder
        // If running locally, you must replace JSON.parse(__firebase_config) with your actual config object
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : { apiKey: "YOUR_API_KEY_HERE", authDomain: "test.firebaseapp.com", projectId: "test" }; 
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'school-fin-app';

        // --- Utility: Script Loader for PDF/Excel ---
        const loadScript = (src) => {
            return new Promise((resolve, reject) => {
                if (document.querySelector(`script[src="${src}"]`)) {
                    resolve();
                    return;
                }
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        };

        // --- Components ---

        // 1. Reusable Minimal Modal
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-gray-900/20 backdrop-blur-sm p-4 transition-all">
                    <div className="bg-white rounded-2xl shadow-xl w-full max-w-lg overflow-hidden border border-gray-100 animate-fade-in-up">
                        <div className="flex justify-between items-center p-6 pb-0">
                            <h3 className="text-xl font-semibold text-gray-900 tracking-tight">{title}</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 transition-colors p-2 rounded-full hover:bg-gray-50">
                                <X size={20} />
                            </button>
                        </div>
                        <div className="p-6 max-h-[80vh] overflow-y-auto custom-scrollbar">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // 2. Minimal Stat Card (Original Design)
        const StatCard = ({ title, value, subtext, icon: Icon, colorClass, trend }) => (
            <div className="bg-white p-6 rounded-2xl border border-gray-100 hover:border-gray-200 transition-all duration-300">
                <div className="flex items-start justify-between mb-4">
                    <div>
                        <h3 className="text-gray-500 text-sm font-medium mb-1">{title}</h3>
                        <p className="text-3xl font-semibold text-gray-900 tracking-tight">{value}</p>
                    </div>
                    <div className={`p-3 rounded-xl ${colorClass} bg-opacity-5`}>
                        <Icon className={colorClass} size={22} strokeWidth={1.5} />
                    </div>
                </div>
                {subtext && (
                    <div className="flex items-center gap-2">
                        {trend && (
                            <span className={`text-xs font-medium px-2 py-0.5 rounded-full ${trend >= 0 ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>
                                {trend >= 0 ? '+' : ''}{trend}%
                            </span>
                        )}
                        <p className="text-xs text-gray-400">{subtext}</p>
                    </div>
                )}
            </div>
        );

        // 3. Simple Bar Chart
        const SimpleBarChart = ({ data, height = 200 }) => {
            const maxVal = Math.max(...data.map(d => Math.max(d.income, d.expense)), 1);
            
            return (
                <div className="w-full" style={{ height }}>
                    <div className="flex h-full items-end gap-3 md:gap-6 px-2">
                        {data.map((d, i) => (
                            <div key={i} className="flex-1 flex flex-col justify-end gap-2 group relative">
                                {/* Tooltip */}
                                <div className="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-xs py-1 px-2 rounded shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-10">
                                    In: {d.income} | Out: {d.expense}
                                </div>
                                
                                <div className="w-full flex gap-1.5 items-end h-full">
                                    <div 
                                        className="flex-1 bg-gray-900 rounded-t-sm opacity-80 group-hover:opacity-100 transition-all"
                                        style={{ height: `${(d.income / maxVal) * 100}%`, minHeight: '4px' }}
                                    />
                                    <div 
                                        className="flex-1 bg-gray-300 rounded-t-sm group-hover:bg-gray-400 transition-all"
                                        style={{ height: `${(d.expense / maxVal) * 100}%`, minHeight: '4px' }}
                                    />
                                </div>
                                <span className="text-[10px] uppercase tracking-wider text-gray-400 text-center w-full font-medium">{d.label}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // Main Application Component
        function SchoolFinanceApp() {
            // --- State ---
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            const [loading, setLoading] = useState(true);
            
            // Data State
            const [income, setIncome] = useState([]);
            const [expenses, setExpenses] = useState([]);
            
            // Modal State
            const [isIncomeModalOpen, setIncomeModalOpen] = useState(false);
            const [isExpenseModalOpen, setExpenseModalOpen] = useState(false);
            const [editingItem, setEditingItem] = useState(null);

            // Form State
            const [formData, setFormData] = useState({});

            // Filters
            const [dateRange, setDateRange] = useState('month'); // 'today', 'week', 'month', 'year'
            const [customStartDate, setCustomStartDate] = useState('');
            const [customEndDate, setCustomEndDate] = useState('');

            // --- Auth & Data Loading ---
            useEffect(() => {
                const initApp = async () => {
                    // Load Export Libraries
                    try {
                        await Promise.all([
                            loadScript('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js'),
                            loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js'),
                            loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js')
                        ]);
                    } catch (e) {
                        console.error("Failed to load export libraries", e);
                    }

                    // Auth
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };

                initApp();
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    if (!currentUser) setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // Fetch Data
            useEffect(() => {
                if (!user) return;
                
                // Listen to Income
                const incomeRef = collection(db, 'artifacts', appId, 'users', user.uid, 'income');
                const unsubIncome = onSnapshot(incomeRef, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    data.sort((a, b) => new Date(b.date) - new Date(a.date));
                    setIncome(data);
                    setLoading(false);
                }, (error) => console.error("Income fetch error:", error));

                // Listen to Expenses
                const expenseRef = collection(db, 'artifacts', appId, 'users', user.uid, 'expenses');
                const unsubExpenses = onSnapshot(expenseRef, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    data.sort((a, b) => new Date(b.date) - new Date(a.date));
                    setExpenses(data);
                }, (error) => console.error("Expense fetch error:", error));

                return () => {
                    unsubIncome();
                    unsubExpenses();
                };
            }, [user]);

            // --- Helpers ---
            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('en-PK', { style: 'currency', currency: 'PKR', minimumFractionDigits: 0 }).format(amount);
            };

            const resetForm = () => {
                setFormData({});
                setEditingItem(null);
            };

            // --- CRUD Operations ---
            const handleSaveIncome = async (e) => {
                e.preventDefault();
                if (!user) return;
                
                const data = {
                    ...formData,
                    amount: parseFloat(formData.amount),
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                    type: 'income' // marker
                };

                try {
                    const colRef = collection(db, 'artifacts', appId, 'users', user.uid, 'income');
                    if (editingItem) {
                        await updateDoc(doc(colRef, editingItem.id), data);
                    } else {
                        await addDoc(colRef, data);
                    }
                    setIncomeModalOpen(false);
                    resetForm();
                } catch (err) {
                    console.error("Error saving income:", err);
                }
            };

            const handleSaveExpense = async (e) => {
                e.preventDefault();
                if (!user) return;

                const data = {
                    ...formData,
                    amount: parseFloat(formData.amount),
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                    type: 'expense' // marker
                };

                try {
                    const colRef = collection(db, 'artifacts', appId, 'users', user.uid, 'expenses');
                    if (editingItem) {
                        await updateDoc(doc(colRef, editingItem.id), data);
                    } else {
                        await addDoc(colRef, data);
                    }
                    setExpenseModalOpen(false);
                    resetForm();
                } catch (err) {
                    console.error("Error saving expense:", err);
                }
            };

            const handleDelete = async (collectionName, id) => {
                if (!confirm('Are you sure you want to delete this record?')) return;
                if (!user) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, collectionName, id));
                } catch (err) {
                    console.error("Error deleting:", err);
                }
            };

            const openEdit = (item, type) => {
                setEditingItem(item);
                setFormData(item);
                if (type === 'income') setIncomeModalOpen(true);
                else setExpenseModalOpen(true);
            };

            // --- Calculations & Reporting Logic ---
            
            const getFilteredData = (dataList) => {
                const now = new Date();
                const start = new Date();
                
                if (dateRange === 'today') {
                    start.setHours(0, 0, 0, 0);
                } else if (dateRange === 'week') {
                    start.setDate(now.getDate() - 7);
                } else if (dateRange === 'month') {
                    start.setMonth(now.getMonth(), 1); // Start of current month
                    start.setHours(0,0,0,0);
                } else if (dateRange === 'custom' && customStartDate) {
                    return dataList.filter(item => {
                        const itemDate = new Date(item.date);
                        const s = new Date(customStartDate);
                        const e = customEndDate ? new Date(customEndDate) : new Date();
                        e.setHours(23, 59, 59, 999);
                        return itemDate >= s && itemDate <= e;
                    });
                } else {
                    return dataList; 
                }

                if (dateRange !== 'all' && dateRange !== 'custom') {
                    return dataList.filter(item => new Date(item.date) >= start);
                }
                return dataList;
            };

            const filteredIncome = useMemo(() => getFilteredData(income), [income, dateRange, customStartDate, customEndDate]);
            const filteredExpenses = useMemo(() => getFilteredData(expenses), [expenses, dateRange, customStartDate, customEndDate]);

            const totalIncome = filteredIncome.reduce((acc, curr) => acc + (Number(curr.amount) || 0), 0);
            const totalExpense = filteredExpenses.reduce((acc, curr) => acc + (Number(curr.amount) || 0), 0);
            const balance = totalIncome - totalExpense;

            // Chart Data Preparation (Last 6 Months)
            const chartData = useMemo(() => {
                const months = [];
                const today = new Date();
                for(let i=5; i>=0; i--) {
                    const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                    const monthLabel = d.toLocaleString('default', { month: 'short' });
                    
                    const monthIncome = income.filter(item => {
                        const idate = new Date(item.date);
                        return idate.getMonth() === d.getMonth() && idate.getFullYear() === d.getFullYear();
                    }).reduce((sum, item) => sum + Number(item.amount), 0);
                    
                    const monthExpense = expenses.filter(item => {
                        const idate = new Date(item.date);
                        return idate.getMonth() === d.getMonth() && idate.getFullYear() === d.getFullYear();
                    }).reduce((sum, item) => sum + Number(item.amount), 0);

                    months.push({
                        label: monthLabel,
                        income: monthIncome,
                        expense: monthExpense
                    });
                }
                return months;
            }, [income, expenses]);

            // --- Exports ---
            const exportToPDF = () => {
                if (!window.jspdf) {
                    alert("PDF library loading... please try again in a moment.");
                    return;
                }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Minimal Header
                doc.setFontSize(22);
                doc.setTextColor(30, 30, 30);
                doc.text("School Financial Report", 14, 25);
                
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 32);
                doc.text(`Period: ${dateRange.toUpperCase()}`, 14, 37);

                // Summary Box
                doc.setDrawColor(230);
                doc.setFillColor(250, 250, 250);
                doc.rect(14, 45, 180, 25, 'FD');
                
                doc.setTextColor(50);
                doc.setFontSize(11);
                doc.text(`Income: ${formatCurrency(totalIncome)}`, 20, 58);
                doc.text(`Expenses: ${formatCurrency(totalExpense)}`, 80, 58);
                doc.setFont("helvetica", "bold");
                doc.text(`Net: ${formatCurrency(balance)}`, 140, 58);
                doc.setFont("helvetica", "normal");

                // Tables
                let finalY = 80;
                
                // Income
                doc.setFontSize(14);
                doc.setTextColor(30);
                doc.text("Income", 14, finalY);
                
                doc.autoTable({
                    startY: finalY + 5,
                    head: [['Date', 'Student', 'Class', 'Type', 'Amount']],
                    body: filteredIncome.map(i => [i.date, i.studentName || '-', i.classSection || '-', i.feeType, formatCurrency(i.amount)]),
                    theme: 'plain',
                    styles: { fontSize: 9, cellPadding: 3 },
                    headStyles: { fillColor: [240, 240, 240], textColor: 50, fontStyle: 'bold' },
                    columnStyles: { 4: { halign: 'right' } }
                });
                
                finalY = doc.lastAutoTable.finalY + 15;

                // Expense
                doc.text("Expenses", 14, finalY);
                doc.autoTable({
                    startY: finalY + 5,
                    head: [['Date', 'Category', 'Description', 'Paid To', 'Amount']],
                    body: filteredExpenses.map(e => [e.date, e.category, e.description, e.paidTo || '-', formatCurrency(e.amount)]),
                    theme: 'plain',
                    styles: { fontSize: 9, cellPadding: 3 },
                    headStyles: { fillColor: [240, 240, 240], textColor: 50, fontStyle: 'bold' },
                    columnStyles: { 4: { halign: 'right' } }
                });

                doc.save('school_expenses_report.pdf');
            };

            const exportToExcel = () => {
                if (!window.XLSX) {
                    alert("Excel library loading... please try again.");
                    return;
                }
                
                const wb = window.XLSX.utils.book_new();
                
                const summaryData = [
                    ['School Expenses & Income Report'],
                    ['Generated On', new Date().toLocaleString()],
                    ['Period', dateRange],
                    [''],
                    ['Metric', 'Amount'],
                    ['Total Income', totalIncome],
                    ['Total Expenses', totalExpense],
                    ['Net Balance', balance]
                ];
                const wsSummary = window.XLSX.utils.aoa_to_sheet(summaryData);
                window.XLSX.utils.book_append_sheet(wb, wsSummary, "Summary");

                const wsIncome = window.XLSX.utils.json_to_sheet(filteredIncome.map(i => ({
                    Date: i.date,
                    Student: i.studentName,
                    Class: i.classSection,
                    Type: i.feeType,
                    Amount: i.amount,
                    Method: i.paymentMethod,
                    Remarks: i.remarks
                })));
                window.XLSX.utils.book_append_sheet(wb, wsIncome, "Income");

                const wsExpense = window.XLSX.utils.json_to_sheet(filteredExpenses.map(e => ({
                    Date: e.date,
                    Category: e.category,
                    Description: e.description,
                    PaidTo: e.paidTo,
                    Amount: e.amount,
                    Method: e.paymentMethod,
                    Remarks: e.remarks
                })));
                window.XLSX.utils.book_append_sheet(wb, wsExpense, "Expenses");

                window.XLSX.writeFile(wb, "school_finance_data.xlsx");
            };

            // --- Views ---

            const DashboardView = () => (
                <div className="space-y-6">
                    {/* KPI Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <StatCard 
                            title="Total Income" 
                            value={formatCurrency(totalIncome)} 
                            icon={TrendingUp} 
                            colorClass="text-gray-900"
                            subtext={`Period: ${dateRange}`}
                        />
                        <StatCard 
                            title="Total Expenses" 
                            value={formatCurrency(totalExpense)} 
                            icon={TrendingDown} 
                            colorClass="text-gray-500"
                            subtext={`Period: ${dateRange}`}
                        />
                        <StatCard 
                            title="Net Balance" 
                            value={formatCurrency(balance)} 
                            icon={DollarSign} 
                            colorClass="text-black"
                            subtext="Available funds"
                        />
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* Chart Section */}
                        <div className="bg-white p-8 rounded-2xl border border-gray-100 shadow-sm">
                            <h3 className="text-base font-semibold text-gray-900 mb-8">Financial Overview</h3>
                            <SimpleBarChart data={chartData} />
                        </div>

                        {/* Recent Transactions */}
                        <div className="bg-white p-8 rounded-2xl border border-gray-100 shadow-sm">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="text-base font-semibold text-gray-900">Recent Activity</h3>
                                <span className="text-xs text-gray-400 uppercase tracking-wider">Latest 5</span>
                            </div>
                            <div className="space-y-0">
                                {[...income.map(i => ({...i, type: 'inc'})), ...expenses.map(e => ({...e, type: 'exp'}))]
                                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                                    .slice(0, 5)
                                    .map((t, idx) => (
                                    <div key={t.id} className={`flex items-center justify-between py-4 ${idx !== 4 ? 'border-b border-gray-50' : ''} group`}>
                                        <div className="flex items-center gap-4">
                                            <div className={`w-2 h-2 rounded-full ${t.type === 'inc' ? 'bg-gray-900' : 'bg-gray-300'}`}></div>
                                            <div>
                                                <p className="font-medium text-gray-900 text-sm">
                                                    {t.type === 'inc' ? (t.studentName || t.feeType) : (t.description || t.category)}
                                                </p>
                                                <p className="text-xs text-gray-400 mt-0.5">{t.date}</p>
                                            </div>
                                        </div>
                                        <span className={`font-medium text-sm tracking-tight ${t.type === 'inc' ? 'text-gray-900' : 'text-gray-500'}`}>
                                            {t.type === 'inc' ? '+' : '-'}{formatCurrency(t.amount)}
                                        </span>
                                    </div>
                                ))}
                                {income.length === 0 && expenses.length === 0 && (
                                    <p className="text-center text-gray-400 py-8 text-sm">No recent activity.</p>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );

            const IncomeView = () => (
                <div className="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
                    <div className="p-6 border-b border-gray-50 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <h2 className="text-lg font-semibold text-gray-900 tracking-tight">Income Records</h2>
                        <button 
                            onClick={() => { resetForm(); setFormData({ date: new Date().toISOString().split('T')[0], paymentMethod: 'Cash' }); setIncomeModalOpen(true); }}
                            className="bg-gray-900 hover:bg-black text-white px-5 py-2.5 rounded-xl text-sm font-medium flex items-center gap-2 transition-all w-full sm:w-auto justify-center shadow-lg shadow-gray-200"
                        >
                            <Plus size={16} /> Add Income
                        </button>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-50/50 text-gray-500 font-medium">
                                <tr>
                                    <th className="px-6 py-4 font-normal">Date</th>
                                    <th className="px-6 py-4 font-normal">Source</th>
                                    <th className="px-6 py-4 font-normal">Class</th>
                                    <th className="px-6 py-4 font-normal">Type</th>
                                    <th className="px-6 py-4 font-normal text-right">Amount</th>
                                    <th className="px-6 py-4 font-normal text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-50">
                                {filteredIncome.map(item => (
                                    <tr key={item.id} className="hover:bg-gray-50/50 transition-colors group">
                                        <td className="px-6 py-4 text-gray-600">{item.date}</td>
                                        <td className="px-6 py-4 font-medium text-gray-900">{item.studentName}</td>
                                        <td className="px-6 py-4 text-gray-500">{item.classSection || '-'}</td>
                                        <td className="px-6 py-4">
                                            <span className="px-2.5 py-1 bg-gray-100 text-gray-600 rounded-md text-xs font-medium">
                                                {item.feeType}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4 text-right font-medium text-gray-900">{formatCurrency(item.amount)}</td>
                                        <td className="px-6 py-4 flex justify-center gap-3 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button onClick={() => openEdit(item, 'income')} className="text-gray-400 hover:text-gray-900 transition-colors"><Edit size={16} /></button>
                                            <button onClick={() => handleDelete('income', item.id)} className="text-gray-400 hover:text-red-600 transition-colors"><Trash2 size={16} /></button>
                                        </td>
                                    </tr>
                                ))}
                                {filteredIncome.length === 0 && (
                                    <tr><td colSpan="6" className="text-center py-12 text-gray-400 font-light">No records found.</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );

            const ExpenseView = () => (
                <div className="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
                    <div className="p-6 border-b border-gray-50 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <h2 className="text-lg font-semibold text-gray-900 tracking-tight">Expense Records</h2>
                        <button 
                            onClick={() => { resetForm(); setFormData({ date: new Date().toISOString().split('T')[0], paymentMethod: 'Cash' }); setExpenseModalOpen(true); }}
                            className="bg-gray-900 hover:bg-black text-white px-5 py-2.5 rounded-xl text-sm font-medium flex items-center gap-2 transition-all w-full sm:w-auto justify-center shadow-lg shadow-gray-200"
                        >
                            <Plus size={16} /> Add Expense
                        </button>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-50/50 text-gray-500 font-medium">
                                <tr>
                                    <th className="px-6 py-4 font-normal">Date</th>
                                    <th className="px-6 py-4 font-normal">Category</th>
                                    <th className="px-6 py-4 font-normal">Description</th>
                                    <th className="px-6 py-4 font-normal">Paid To</th>
                                    <th className="px-6 py-4 font-normal text-right">Amount</th>
                                    <th className="px-6 py-4 font-normal text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-50">
                                {filteredExpenses.map(item => (
                                    <tr key={item.id} className="hover:bg-gray-50/50 transition-colors group">
                                        <td className="px-6 py-4 text-gray-600">{item.date}</td>
                                        <td className="px-6 py-4">
                                            <span className="px-2.5 py-1 bg-gray-100 text-gray-600 rounded-md text-xs font-medium">
                                                {item.category}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4 max-w-xs truncate text-gray-500">{item.description}</td>
                                        <td className="px-6 py-4 text-gray-500">{item.paidTo || '-'}</td>
                                        <td className="px-6 py-4 text-right font-medium text-gray-900">{formatCurrency(item.amount)}</td>
                                        <td className="px-6 py-4 flex justify-center gap-3 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button onClick={() => openEdit(item, 'expense')} className="text-gray-400 hover:text-gray-900 transition-colors"><Edit size={16} /></button>
                                            <button onClick={() => handleDelete('expenses', item.id)} className="text-gray-400 hover:text-red-600 transition-colors"><Trash2 size={16} /></button>
                                        </td>
                                    </tr>
                                ))}
                                {filteredExpenses.length === 0 && (
                                    <tr><td colSpan="6" className="text-center py-12 text-gray-400 font-light">No records found.</td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );

            const ReportsView = () => (
                <div className="space-y-6">
                    <div className="bg-white rounded-2xl p-8 border border-gray-100 shadow-sm flex flex-col md:flex-row justify-between items-center gap-6">
                        <div>
                            <h2 className="text-xl font-semibold text-gray-900 mb-1">Export Data</h2>
                            <p className="text-gray-500 text-sm">Download your financial data for external analysis.</p>
                        </div>
                        
                        <div className="flex gap-4">
                            <button onClick={exportToPDF} className="bg-white border border-gray-200 hover:border-gray-400 text-gray-700 px-6 py-2.5 rounded-xl font-medium flex items-center gap-2 transition-all shadow-sm">
                                <FileText size={18} /> PDF Report
                            </button>
                            <button onClick={exportToExcel} className="bg-gray-900 hover:bg-black text-white px-6 py-2.5 rounded-xl font-medium flex items-center gap-2 transition-all shadow-lg shadow-gray-200">
                                <Download size={18} /> Excel File
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-white p-8 rounded-2xl border border-gray-100 shadow-sm">
                            <h3 className="font-semibold text-gray-900 mb-6 pb-4 border-b border-gray-50">Income by Type</h3>
                            <div className="space-y-4">
                                {Object.entries(filteredIncome.reduce((acc, curr) => {
                                    acc[curr.feeType] = (acc[curr.feeType] || 0) + Number(curr.amount);
                                    return acc;
                                }, {})).map(([key, val]) => (
                                    <div key={key} className="flex justify-between items-center text-sm group">
                                        <span className="text-gray-500 group-hover:text-gray-700 transition-colors">{key}</span>
                                        <span className="font-medium text-gray-900 bg-gray-50 px-2 py-1 rounded">{formatCurrency(val)}</span>
                                    </div>
                                ))}
                                {filteredIncome.length === 0 && <p className="text-gray-400 text-sm text-center">No data available</p>}
                            </div>
                        </div>
                        <div className="bg-white p-8 rounded-2xl border border-gray-100 shadow-sm">
                            <h3 className="font-semibold text-gray-900 mb-6 pb-4 border-b border-gray-50">Expenses by Category</h3>
                            <div className="space-y-4">
                                {Object.entries(filteredExpenses.reduce((acc, curr) => {
                                    acc[curr.category] = (acc[curr.category] || 0) + Number(curr.amount);
                                    return acc;
                                }, {})).map(([key, val]) => (
                                    <div key={key} className="flex justify-between items-center text-sm group">
                                        <span className="text-gray-500 group-hover:text-gray-700 transition-colors">{key}</span>
                                        <span className="font-medium text-gray-900 bg-gray-50 px-2 py-1 rounded">{formatCurrency(val)}</span>
                                    </div>
                                ))}
                                {filteredExpenses.length === 0 && <p className="text-gray-400 text-sm text-center">No data available</p>}
                            </div>
                        </div>
                    </div>
                </div>
            );

            // --- Main Layout Render ---
            if (loading) return <div className="min-h-screen flex items-center justify-center bg-gray-50 text-gray-400 font-light">Loading...</div>;

            return (
                <div className="min-h-screen bg-gray-50/50 text-gray-900 font-sans flex overflow-hidden">
                    
                    {/* Minimalist Sidebar */}
                    <aside className={`fixed md:relative z-20 h-full bg-white border-r border-gray-100 transition-all duration-300 flex flex-col ${isSidebarOpen ? 'w-72 translate-x-0' : 'w-0 -translate-x-full md:w-20 md:translate-x-0'}`}>
                        <div className="p-6 border-b border-gray-50 flex items-center gap-3 h-20">
                            <div className="w-8 h-8 rounded-lg bg-gray-900 flex items-center justify-center font-bold text-white shrink-0 text-sm">S</div>
                            {isSidebarOpen && <span className="font-semibold text-sm leading-tight text-gray-900">School Expenses<br/>& Income Management</span>}
                        </div>

                        <nav className="flex-1 py-8 space-y-1 px-4 overflow-y-auto">
                            {[
                                { id: 'dashboard', label: 'Dashboard', icon: LayoutDashboard },
                                { id: 'income', label: 'Income', icon: TrendingUp },
                                { id: 'expenses', label: 'Expenses', icon: TrendingDown },
                                { id: 'reports', label: 'Reports', icon: FileText },
                            ].map((item) => {
                                const isActive = activeTab === item.id;
                                let activeClass = 'bg-gray-50 text-gray-900';
                                
                                if (isActive) {
                                    if (item.id === 'income') activeClass = 'bg-emerald-50 text-emerald-700';
                                    else if (item.id === 'expenses') activeClass = 'bg-rose-50 text-rose-700';
                                }

                                return (
                                    <button
                                        key={item.id}
                                        onClick={() => { setActiveTab(item.id); if(window.innerWidth < 768) setIsSidebarOpen(false); }}
                                        className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-sm font-medium ${isActive ? activeClass : 'text-gray-500 hover:bg-gray-50/50 hover:text-gray-700'}`}
                                    >
                                        <item.icon size={18} className="shrink-0" strokeWidth={2} />
                                        {isSidebarOpen && <span>{item.label}</span>}
                                    </button>
                                );
                            })}
                        </nav>

                        <div className="p-6 border-t border-gray-50">
                            <div className={`flex items-center gap-3 ${!isSidebarOpen && 'justify-center'}`}>
                                {isSidebarOpen && (
                                    <div className="overflow-hidden">
                                        <p className="text-sm font-medium text-gray-900">Developed by SB School</p>
                                        <p className="text-xs text-gray-400">Branch Khushab</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 flex flex-col h-full overflow-hidden w-full relative bg-gray-50/30">
                        {/* Header */}
                        <header className="h-20 bg-white/80 backdrop-blur-sm border-b border-gray-100 flex items-center justify-between px-6 sm:px-8 shrink-0 z-10 sticky top-0">
                            <div className="flex items-center gap-4">
                                <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="text-gray-400 hover:text-gray-600 transition-colors">
                                    <Menu size={20} />
                                </button>
                                <h1 className="text-lg font-semibold text-gray-900 hidden sm:block tracking-tight">
                                    {activeTab === 'dashboard' ? 'Overview' : 
                                    activeTab === 'income' ? 'Income Management' : 
                                    activeTab === 'expenses' ? 'Expense Management' : 'Reports & Analytics'}
                                </h1>
                            </div>

                            {/* Date Filter Global */}
                            <div className="flex items-center gap-2 bg-gray-100/50 p-1 rounded-lg">
                                <select 
                                    value={dateRange} 
                                    onChange={(e) => setDateRange(e.target.value)}
                                    className="bg-transparent text-gray-600 text-sm font-medium border-none focus:ring-0 cursor-pointer py-1 px-2"
                                >
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="all">All Time</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                        </header>

                        {/* Custom Date Range Picker */}
                        {dateRange === 'custom' && (
                            <div className="bg-white px-8 py-3 flex flex-wrap gap-4 items-center text-sm border-b border-gray-100">
                                <span className="font-medium text-gray-600">Range:</span>
                                <input type="date" value={customStartDate} onChange={e => setCustomStartDate(e.target.value)} className="border border-gray-200 rounded-md px-2 py-1 text-gray-700 focus:outline-none focus:border-gray-400" />
                                <span className="text-gray-400">-</span>
                                <input type="date" value={customEndDate} onChange={e => setCustomEndDate(e.target.value)} className="border border-gray-200 rounded-md px-2 py-1 text-gray-700 focus:outline-none focus:border-gray-400" />
                            </div>
                        )}

                        {/* Scrollable Content */}
                        <div className="flex-1 overflow-y-auto p-6 sm:p-8 pb-20 custom-scrollbar">
                            <div className="max-w-7xl mx-auto space-y-8">
                                {activeTab === 'dashboard' && <DashboardView />}
                                {activeTab === 'income' && <IncomeView />}
                                {activeTab === 'expenses' && <ExpenseView />}
                                {activeTab === 'reports' && <ReportsView />}
                            </div>
                        </div>
                    </main>

                    {/* --- Minimal Modals --- */}
                    
                    <Modal isOpen={isIncomeModalOpen} onClose={() => setIncomeModalOpen(false)} title={editingItem ? "Edit Income" : "New Income"}>
                        <form onSubmit={handleSaveIncome} className="space-y-5">
                            <div className="grid grid-cols-2 gap-5">
                                <div>
                                    <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Date</label>
                                    <input type="date" required value={formData.date || ''} onChange={e => setFormData({...formData, date: e.target.value})} className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:bg-white focus:border-gray-400 outline-none transition-all text-sm" />
                                </div>
                                <div>
                                    <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Amount</label>
                                    <input type="number" required min="0" placeholder="0.00" value={formData.amount || ''} onChange={e => setFormData({...formData, amount: e.target.value})} className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:bg-white focus:border-gray-400 outline-none transition-all text-sm" />
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Fee Type</label>
                                <select required value={formData.feeType || ''} onChange={e => setFormData({...formData, feeType: e.target.value})} className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:bg-white focus:border-gray-400 outline-none transition-all text-sm appearance-none">
                                    <option value="">Select Type</option>
                                    <option value="School Fee">School Fee</option>
                                    <option value="Admission Fee">Admission Fee</option>
                                    <option value="Annual Fee">Annual Fee</option>
                                    <option value="Transport Fee">Transport Fee</option>
                                    <option value="Exam Fee">Exam Fee</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>

                            <div>
                                <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Student Name</label>
                                <input type="text" placeholder="Student Name" value={formData.studentName || ''} onChange={e => setFormData({...formData, studentName: e.target.value})} className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:bg-white focus:border-gray-400 outline-none transition-all text-sm" />
                            </div>

                            <div className="grid grid-cols-2 gap-5">
                                <div>
                                    <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Class</label>
                                    <input type="text" placeholder="e.g. 5-A" value={formData.classSection || ''} onChange={e => setFormData({...formData, classSection: e.target.value})} className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:bg-white focus:border-gray-400 outline-none transition-all text-sm" />
                                </div>
                                <div>
                                    <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Method</label>
                                    <select value={formData.paymentMethod || 'Cash'} onChange={e => setFormData({...formData, paymentMethod: e.target.value})} className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:bg-white focus:border-gray-400 outline-none transition-all text-sm">
                                        <option value="Cash">Cash</option>
                                        <option value="Bank Transfer">Bank Transfer</option>
                                        <option value="Cheque">Cheque</option>
                                        <option value="Online">Online</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Remarks</label>
                                <textarea rows="2" value={formData.remarks || ''} onChange={e => setFormData({...formData, remarks: e.target.value})} className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:bg-white focus:border-gray-400 outline-none transition-all text-sm" placeholder="Optional notes..."></textarea>
                            </div>

                            <div className="pt-2 flex gap-3">
                                <button type="button" onClick={() => setIncomeModalOpen(false)} className="flex-1 py-3 bg-white border border-gray-200 text-gray-600 font-medium rounded-xl hover:bg-gray-50 transition-colors">Cancel</button>
                                <button type="submit" className="flex-1 py-3 bg-gray-900 text-white font-medium rounded-xl hover:bg-black transition-colors shadow-lg shadow-gray-200">Save Record</button>
                            </div>
                        </form>
                    </Modal>

                    <Modal isOpen={isExpenseModalOpen} onClose={() => setExpenseModalOpen(false)} title={editingItem ? "Edit Expense" : "New Expense"}>
                        <form onSubmit={handleSaveExpense} className="space-y-5">
                            <div className="grid grid-cols-2 gap-5">
                                <div>
                                    <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Date</label>
                                    <input type="date" required value={formData.date || ''} onChange={e => setFormData({...formData, date: e.target.value})} className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:bg-white focus:border-gray-400 outline-none transition-all text-sm" />
                                </div>
                                <div>
                                    <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Amount</label>
                                    <input type="number" required min="0" placeholder="0.00" value={formData.amount || ''} onChange={e => setFormData({...formData, amount: e.target.value})} className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:bg-white focus:border-gray-400 outline-none transition-all text-sm" />
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Category</label>
                                <select required value={formData.category || ''} onChange={e => setFormData({...formData, category: e.target.value})} className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:bg-white focus:border-gray-400 outline-none transition-all text-sm">
                                    <option value="">Select Category</option>
                                    <option value="Teacher Salary (Wazaif)">Teacher Salary (Wazaif)</option>
                                    <option value="Office Expenses">Office Expenses</option>
                                    <option value="School Maintenance">School Maintenance</option>
                                    <option value="Utility Bills">Utility Bills</option>
                                    <option value="Event">Event</option>
                                    <option value="Stationery">Stationery</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>

                            <div>
                                <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Description</label>
                                <input type="text" required placeholder="Description" value={formData.description || ''} onChange={e => setFormData({...formData, description: e.target.value})} className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:bg-white focus:border-gray-400 outline-none transition-all text-sm" />
                            </div>

                            <div className="grid grid-cols-2 gap-5">
                                <div>
                                    <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Paid To</label>
                                    <input type="text" placeholder="Name" value={formData.paidTo || ''} onChange={e => setFormData({...formData, paidTo: e.target.value})} className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:bg-white focus:border-gray-400 outline-none transition-all text-sm" />
                                </div>
                                <div>
                                    <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Method</label>
                                    <select value={formData.paymentMethod || 'Cash'} onChange={e => setFormData({...formData, paymentMethod: e.target.value})} className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:bg-white focus:border-gray-400 outline-none transition-all text-sm">
                                        <option value="Cash">Cash</option>
                                        <option value="Bank Transfer">Bank Transfer</option>
                                        <option value="Cheque">Cheque</option>
                                        <option value="Online">Online</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Remarks</label>
                                <textarea rows="2" value={formData.remarks || ''} onChange={e => setFormData({...formData, remarks: e.target.value})} className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:bg-white focus:border-gray-400 outline-none transition-all text-sm" placeholder="Optional notes..."></textarea>
                            </div>

                            <div className="pt-2 flex gap-3">
                                <button type="button" onClick={() => setExpenseModalOpen(false)} className="flex-1 py-3 bg-white border border-gray-200 text-gray-600 font-medium rounded-xl hover:bg-gray-50 transition-colors">Cancel</button>
                                <button type="submit" className="flex-1 py-3 bg-gray-900 text-white font-medium rounded-xl hover:bg-black transition-colors shadow-lg shadow-gray-200">Save Record</button>
                            </div>
                        </form>
                    </Modal>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SchoolFinanceApp />);
    </script>
</body>
</html>
