<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduFinance - School Management</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Print Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; }
        
        @media print {
            .print-hidden { display: none !important; }
            .print-grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)) !important; }
            .print-gap-4 { gap: 1rem !important; }
            body { background: white; }
            #sidebar { display: none !important; }
            #mobile-header { display: none !important; }
            #main-content { overflow: visible !important; height: auto !important; }
        }

        /* Loading Spinner Animation */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 h-screen overflow-hidden flex">

    <!-- App Container -->
    <div id="app" class="flex w-full h-full">
        <!-- Content will be injected here by JavaScript -->
    </div>

    <!-- Firebase & App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, deleteDoc, doc, orderBy, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- Configuration (Environment Variables would be injected here) ---
        // For this file to run, __firebase_config and __app_id need to be defined in the window scope
        // or replaced with actual values.
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        const appId = window.__app_id || 'default-app-id';

        // --- Firebase Init ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- State Management ---
        const state = {
            user: null,
            view: 'dashboard',
            transactions: [],
            mobileOpen: false,
            loading: false,
            filters: {
                type: 'all',
                startDate: new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0],
                endDate: new Date().toISOString().split('T')[0]
            }
        };

        // --- Helper Functions ---
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-PK', {
                style: 'currency',
                currency: 'PKR',
                minimumFractionDigits: 0
            }).format(amount);
        };

        const formatDate = (dateInput) => {
            if (!dateInput) return '';
            // Handle Firestore Timestamp or JS Date or String
            const date = dateInput.toDate ? dateInput.toDate() : new Date(dateInput);
            return new Intl.DateTimeFormat('en-GB', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            }).format(date);
        };

        const generateCSV = (data) => {
            const headers = ['Date', 'Type', 'Category', 'Description', 'Student/Payee', 'Method', 'Amount'];
            const rows = data.map(item => [
                formatDate(item.date),
                item.type.toUpperCase(),
                item.category,
                `"${item.description || ''}"`,
                `"${item.studentName || item.paidTo || ''}"`,
                item.paymentMethod,
                item.amount
            ]);
            
            const csvContent = [headers.join(','), ...rows.map(e => e.join(','))].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `School_Finance_Report_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        };

        // --- Logic Handlers ---
        
        async function handleAddTransaction(e, type) {
            e.preventDefault();
            if (!state.user) return;
            
            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            state.loading = true;
            render(); // Show loading state

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'school_finance_transactions'), {
                    ...data,
                    type: type,
                    amount: Number(data.amount),
                    date: Timestamp.fromDate(new Date(data.date)),
                    createdAt: serverTimestamp(),
                    userId: state.user.uid
                });
                alert("Entry saved successfully!");
                form.reset();
                // Reset date to today after reset
                state.view = 'dashboard';
            } catch (error) {
                console.error("Error adding document: ", error);
                alert("Failed to save entry. Please try again.");
            } finally {
                state.loading = false;
                render();
            }
        }

        async function handleDeleteTransaction(id) {
            if (!state.user || !window.confirm('Are you sure you want to delete this record?')) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'school_finance_transactions', id));
            } catch (error) {
                console.error("Error deleting document: ", error);
            }
        }

        // --- Render Functions (Components) ---

        const Icons = {
            Dashboard: 'layout-dashboard',
            Income: 'trending-up',
            Expense: 'trending-down',
            Reports: 'file-text',
            School: 'school',
            Wallet: 'wallet',
            Printer: 'printer',
            Download: 'download',
            Trash: 'trash-2',
            Menu: 'menu',
            Close: 'x',
            Plus: 'plus-circle'
        };

        function renderSidebar() {
            const menuItems = [
                { id: 'dashboard', label: 'Dashboard', icon: Icons.Dashboard },
                { id: 'income', label: 'Income Entry', icon: Icons.Income },
                { id: 'expense', label: 'Expense Entry', icon: Icons.Expense },
                { id: 'reports', label: 'Financial Reports', icon: Icons.Reports },
            ];

            const navHTML = menuItems.map(item => `
                <button
                    onclick="window.setView('${item.id}')"
                    class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors ${
                        state.view === item.id 
                        ? 'bg-emerald-600 text-white shadow-lg' 
                        : 'text-slate-300 hover:bg-slate-800 hover:text-white'
                    }"
                >
                    <i data-lucide="${item.icon}" width="20"></i>
                    <span>${item.label}</span>
                </button>
            `).join('');

            return `
                <!-- Mobile Overlay -->
                <div class="${state.mobileOpen ? 'fixed inset-0 bg-black bg-opacity-50 z-20 lg:hidden' : 'hidden'}"
                     onclick="window.toggleMobileMenu(false)"></div>

                <!-- Sidebar Content -->
                <div id="sidebar" class="fixed lg:static inset-y-0 left-0 z-30 w-64 bg-slate-900 text-white transform transition-transform duration-200 ease-in-out ${state.mobileOpen ? 'translate-x-0' : '-translate-x-full'} lg:translate-x-0 flex flex-col h-full">
                    <div class="p-6 flex items-center justify-between">
                        <div class="flex items-center space-x-2 font-bold text-xl text-emerald-400">
                            <i data-lucide="${Icons.School}" width="28"></i>
                            <span>EduFinance</span>
                        </div>
                        <button onclick="window.toggleMobileMenu(false)" class="lg:hidden text-slate-400 hover:text-white">
                            <i data-lucide="${Icons.Close}" width="24"></i>
                        </button>
                    </div>

                    <nav class="flex-1 px-4 space-y-2 mt-4">
                        ${navHTML}
                    </nav>

                    <div class="p-4 border-t border-slate-800">
                        <div class="flex items-center space-x-3 px-4 py-2 text-slate-400 text-sm">
                            <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                            <span>System Online</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            let totalIncome = 0, totalExpense = 0, monthIncome = 0, monthExpense = 0;

            state.transactions.forEach(t => {
                const amount = Number(t.amount);
                const tDate = t.date?.toDate ? t.date.toDate() : new Date(t.date);
                
                if (t.type === 'income') {
                    totalIncome += amount;
                    if (tDate.getMonth() === currentMonth && tDate.getFullYear() === currentYear) monthIncome += amount;
                } else {
                    totalExpense += amount;
                    if (tDate.getMonth() === currentMonth && tDate.getFullYear() === currentYear) monthExpense += amount;
                }
            });

            const balance = totalIncome - totalExpense;

            // Recent activity rows
            const recentRows = state.transactions.slice(0, 5).map(t => `
                <tr class="border-b border-slate-50 hover:bg-slate-50">
                    <td class="px-6 py-4 text-slate-500">${formatDate(t.date)}</td>
                    <td class="px-6 py-4 font-medium text-slate-900">
                        ${t.type === 'income' ? (t.studentName || t.description) : (t.description || t.paidTo)}
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded text-xs font-medium ${
                            t.type === 'income' ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'
                        }">${t.category}</span>
                    </td>
                    <td class="px-6 py-4 text-right font-bold ${
                        t.type === 'income' ? 'text-emerald-600' : 'text-rose-600'
                    }">
                        ${t.type === 'income' ? '+' : '-'}${formatCurrency(t.amount)}
                    </td>
                </tr>
            `).join('');

            return `
                <div class="space-y-6 animate-fade-in">
                    <h2 class="text-2xl font-bold text-slate-800">Financial Overview</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Income Card -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-4 opacity-10">
                                <i data-lucide="${Icons.Income}" width="64" class="text-emerald-600"></i>
                            </div>
                            <p class="text-sm text-slate-500 font-medium uppercase tracking-wider">Total Income</p>
                            <h3 class="text-3xl font-bold text-slate-800 mt-2">${formatCurrency(totalIncome)}</h3>
                            <div class="mt-4 flex items-center text-sm text-emerald-600 bg-emerald-50 w-fit px-2 py-1 rounded">
                                <i data-lucide="${Icons.Income}" width="14" class="mr-1"></i>
                                <span>This Month: ${formatCurrency(monthIncome)}</span>
                            </div>
                        </div>

                        <!-- Expense Card -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-4 opacity-10">
                                <i data-lucide="${Icons.Expense}" width="64" class="text-rose-600"></i>
                            </div>
                            <p class="text-sm text-slate-500 font-medium uppercase tracking-wider">Total Expenses</p>
                            <h3 class="text-3xl font-bold text-slate-800 mt-2">${formatCurrency(totalExpense)}</h3>
                            <div class="mt-4 flex items-center text-sm text-rose-600 bg-rose-50 w-fit px-2 py-1 rounded">
                                <i data-lucide="${Icons.Expense}" width="14" class="mr-1"></i>
                                <span>This Month: ${formatCurrency(monthExpense)}</span>
                            </div>
                        </div>

                        <!-- Balance Card -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-4 opacity-10">
                                <i data-lucide="${Icons.Wallet}" width="64" class="text-blue-600"></i>
                            </div>
                            <p class="text-sm text-slate-500 font-medium uppercase tracking-wider">Current Balance</p>
                            <h3 class="text-3xl font-bold mt-2 ${balance >= 0 ? 'text-blue-600' : 'text-rose-600'}">
                                ${formatCurrency(balance)}
                            </h3>
                            <div class="mt-4 text-sm text-slate-400">Net available funds</div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="p-6 border-b border-slate-100">
                            <h3 class="font-semibold text-slate-800">Recent Activity</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-50 text-slate-500 uppercase text-xs">
                                    <tr>
                                        <th class="px-6 py-3">Date</th>
                                        <th class="px-6 py-3">Description</th>
                                        <th class="px-6 py-3">Category</th>
                                        <th class="px-6 py-3 text-right">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${recentRows.length ? recentRows : '<tr><td colspan="4" class="px-6 py-8 text-center text-slate-400">No recent transactions found.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderForm(type) {
            const isIncome = type === 'income';
            const categories = isIncome 
                ? ['School Fee', 'Admission Fee', 'Annual Fee', 'Exam Fee', 'Other'] 
                : ['School Expenses', 'Office Expenses', 'Teacher Salary', 'Maintenance', 'Utilities', 'Other'];
            
            const categoryOptions = categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');

            return `
                <div class="max-w-3xl mx-auto animate-fade-in">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="p-6 border-b ${isIncome ? 'bg-emerald-50 border-emerald-100' : 'bg-rose-50 border-rose-100'}">
                            <h2 class="text-xl font-bold flex items-center ${isIncome ? 'text-emerald-800' : 'text-rose-800'}">
                                <i data-lucide="${isIncome ? Icons.Income : Icons.Expense}" class="mr-2"></i>
                                New ${isIncome ? 'Income' : 'Expense'} Entry
                            </h2>
                            <p class="text-slate-500 text-sm mt-1">Record a new financial transaction</p>
                        </div>
                        
                        <form onsubmit="window.submitForm(event, '${type}')" class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="col-span-2 md:col-span-1">
                                <label class="block text-sm font-medium text-slate-700 mb-1">Date</label>
                                <input required type="date" name="date" value="${new Date().toISOString().split('T')[0]}"
                                    class="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition" />
                            </div>
                            <div class="col-span-2 md:col-span-1">
                                <label class="block text-sm font-medium text-slate-700 mb-1">Amount (PKR)</label>
                                <input required type="number" name="amount" placeholder="0.00"
                                    class="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition" />
                            </div>
                            <div class="col-span-2 md:col-span-1">
                                <label class="block text-sm font-medium text-slate-700 mb-1">Category</label>
                                <select name="category" class="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none">
                                    ${categoryOptions}
                                </select>
                            </div>
                            <div class="col-span-2 md:col-span-1">
                                <label class="block text-sm font-medium text-slate-700 mb-1">Payment Method</label>
                                <select name="paymentMethod" class="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none">
                                    <option value="Cash">Cash</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                    <option value="Online">Online / EasyPaisa</option>
                                    <option value="Cheque">Cheque</option>
                                </select>
                            </div>

                            ${isIncome ? `
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Student Name / ID</label>
                                    <input required type="text" name="studentName" placeholder="e.g. Ali Khan (ID-102)"
                                        class="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" />
                                </div>
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Class / Section</label>
                                    <input type="text" name="classSection" placeholder="e.g. Class 5 - A"
                                        class="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" />
                                </div>
                            ` : `
                                <div class="col-span-2">
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Paid To (Optional)</label>
                                    <input type="text" name="paidTo" placeholder="e.g. Stationery Vendor, Mr. Ahmed (Teacher)"
                                        class="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" />
                                </div>
                            `}

                            <div class="col-span-2">
                                <label class="block text-sm font-medium text-slate-700 mb-1">Description / Remarks</label>
                                <textarea name="description" rows="2" placeholder="Any additional details..."
                                    class="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none resize-none"></textarea>
                            </div>

                            <div class="col-span-2 mt-4">
                                <button type="submit" ${state.loading ? 'disabled' : ''} 
                                    class="w-full py-3 px-4 rounded-lg text-white font-semibold shadow-md transition-all transform hover:scale-[1.01] active:scale-[0.99] flex justify-center items-center ${isIncome ? 'bg-emerald-600 hover:bg-emerald-700 shadow-emerald-200' : 'bg-rose-600 hover:bg-rose-700 shadow-rose-200'} ${state.loading ? 'opacity-70 cursor-not-allowed' : ''}">
                                    ${state.loading ? '<div class="spinner"></div>' : `
                                        <i data-lucide="${Icons.Plus}" width="20" class="mr-2"></i>
                                        Save ${isIncome ? 'Income' : 'Expense'}
                                    `}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderReports() {
            // Filter logic
            const filteredData = state.transactions.filter(t => {
                const tDate = t.date?.toDate ? t.date.toDate() : new Date(t.date);
                const start = new Date(state.filters.startDate);
                const end = new Date(state.filters.endDate);
                end.setHours(23, 59, 59);

                const dateMatch = tDate >= start && tDate <= end;
                const typeMatch = state.filters.type === 'all' || t.type === state.filters.type;
                return dateMatch && typeMatch;
            });

            // Calculate totals
            const totals = filteredData.reduce((acc, curr) => {
                const amt = Number(curr.amount);
                if (curr.type === 'income') acc.income += amt;
                else acc.expense += amt;
                return acc;
            }, { income: 0, expense: 0 });

            const net = totals.income - totals.expense;

            // Table Rows
            const tableRows = filteredData.map(t => `
                <tr class="hover:bg-slate-50">
                    <td class="px-6 py-3 text-slate-500 whitespace-nowrap">${formatDate(t.date)}</td>
                    <td class="px-6 py-3">
                        <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide border ${
                            t.type === 'income' 
                            ? 'bg-emerald-50 text-emerald-700 border-emerald-100' 
                            : 'bg-rose-50 text-rose-700 border-rose-100'
                        }">${t.type}</span>
                    </td>
                    <td class="px-6 py-3">
                        <div class="font-medium text-slate-800">
                            ${t.type === 'income' ? (t.studentName || '') : (t.paidTo || '')}
                        </div>
                        <div class="text-xs text-slate-400">${t.description || t.classSection || 'No details'}</div>
                    </td>
                    <td class="px-6 py-3 text-slate-600">${t.category}</td>
                    <td class="px-6 py-3 text-right font-mono font-medium ${
                        t.type === 'income' ? 'text-emerald-600' : 'text-rose-600'
                    }">${formatCurrency(t.amount)}</td>
                    <td class="px-6 py-3 text-center print-hidden">
                        <button onclick="window.deleteTransaction('${t.id}')" class="text-slate-400 hover:text-rose-500 transition" title="Delete Entry">
                            <i data-lucide="${Icons.Trash}" width="16"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            return `
                <div class="space-y-6">
                    <div class="flex flex-col md:flex-row justify-between items-end md:items-center space-y-4 md:space-y-0 print-hidden">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">Financial Reports</h2>
                            <p class="text-slate-500 text-sm">Generate and export transaction history</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="window.print()" class="flex items-center px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 transition">
                                <i data-lucide="${Icons.Printer}" width="18" class="mr-2"></i> Print PDF
                            </button>
                            <button onclick='window.exportCSV()' class="flex items-center px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition">
                                <i data-lucide="${Icons.Download}" width="18" class="mr-2"></i> Export Excel
                            </button>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex flex-col md:flex-row gap-4 print-hidden">
                        <div class="flex-1">
                            <label class="text-xs font-semibold text-slate-500 uppercase">Transaction Type</label>
                            <div class="flex bg-slate-100 rounded-lg p-1 mt-1">
                                ${['all', 'income', 'expense'].map(type => `
                                    <button onclick="window.setFilter('type', '${type}')" 
                                        class="flex-1 py-1.5 text-sm rounded-md capitalize font-medium transition ${state.filters.type === type ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-500 hover:text-slate-700'}">
                                        ${type}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        <div class="flex-1">
                            <label class="text-xs font-semibold text-slate-500 uppercase">Date Range</label>
                            <div class="flex items-center space-x-2 mt-1">
                                <input type="date" value="${state.filters.startDate}" onchange="window.setFilter('startDate', this.value)" class="w-full p-2 text-sm border border-slate-200 rounded-lg">
                                <span class="text-slate-400">-</span>
                                <input type="date" value="${state.filters.endDate}" onchange="window.setFilter('endDate', this.value)" class="w-full p-2 text-sm border border-slate-200 rounded-lg">
                            </div>
                        </div>
                    </div>

                    <!-- Printable Summary -->
                    <div class="grid grid-cols-3 gap-4 print-grid-cols-3 print-gap-4">
                        <div class="bg-emerald-50 border border-emerald-100 p-4 rounded-lg text-center">
                            <h4 class="text-emerald-800 text-sm font-semibold uppercase">Total Income</h4>
                            <p class="text-2xl font-bold text-emerald-700">${formatCurrency(totals.income)}</p>
                        </div>
                        <div class="bg-rose-50 border border-rose-100 p-4 rounded-lg text-center">
                            <h4 class="text-rose-800 text-sm font-semibold uppercase">Total Expenses</h4>
                            <p class="text-2xl font-bold text-rose-700">${formatCurrency(totals.expense)}</p>
                        </div>
                        <div class="bg-blue-50 border border-blue-100 p-4 rounded-lg text-center">
                            <h4 class="text-blue-800 text-sm font-semibold uppercase">Net Balance</h4>
                            <p class="text-2xl font-bold ${net >= 0 ? 'text-blue-700' : 'text-rose-700'}">${formatCurrency(net)}</p>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-50 text-slate-600 uppercase text-xs font-bold">
                                    <tr>
                                        <th class="px-6 py-3">Date</th>
                                        <th class="px-6 py-3">Type</th>
                                        <th class="px-6 py-3">Details</th>
                                        <th class="px-6 py-3">Category</th>
                                        <th class="px-6 py-3 text-right">Amount</th>
                                        <th class="px-6 py-3 text-center print-hidden">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    ${tableRows.length ? tableRows : '<tr><td colspan="6" class="px-6 py-12 text-center text-slate-400 italic">No transactions found for the selected range.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- Main Render Function ---

        function render() {
            const appDiv = document.getElementById('app');
            
            if (!state.user) {
                appDiv.innerHTML = `
                    <div class="w-full h-full flex items-center justify-center bg-slate-100 text-slate-500">
                        <div class="flex flex-col items-center">
                            <div class="spinner border-emerald-600 border-t-emerald-600 mb-4" style="border-color: #059669; border-top-color: transparent;"></div>
                            <p>Initializing System...</p>
                        </div>
                    </div>
                `;
                return;
            }

            let contentHTML = '';
            
            switch (state.view) {
                case 'dashboard': contentHTML = renderDashboard(); break;
                case 'income': contentHTML = renderForm('income'); break;
                case 'expense': contentHTML = renderForm('expense'); break;
                case 'reports': contentHTML = renderReports(); break;
                default: contentHTML = renderDashboard();
            }

            appDiv.innerHTML = `
                ${renderSidebar()}
                <div id="main-content" class="flex-1 flex flex-col h-screen overflow-hidden bg-slate-50">
                    <header id="mobile-header" class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-6 lg:hidden">
                        <div class="flex items-center space-x-2 font-bold text-slate-800">
                            <i data-lucide="${Icons.School}" class="text-emerald-600" width="24"></i>
                            <span>EduFinance</span>
                        </div>
                        <button onclick="window.toggleMobileMenu(true)" class="text-slate-600">
                            <i data-lucide="${Icons.Menu}" width="24"></i>
                        </button>
                    </header>

                    <main class="flex-1 overflow-y-auto p-4 md:p-8">
                        <div class="max-w-7xl mx-auto">
                            ${contentHTML}
                        </div>
                    </main>
                </div>
            `;

            // Re-initialize icons after DOM update
            lucide.createIcons();
        }

        // --- Global Methods for HTML Interaction ---
        
        window.setView = (viewName) => {
            state.view = viewName;
            state.mobileOpen = false;
            render();
        };

        window.toggleMobileMenu = (isOpen) => {
            state.mobileOpen = isOpen;
            render();
        };

        window.submitForm = (e, type) => {
            handleAddTransaction(e, type);
        };

        window.deleteTransaction = (id) => {
            handleDeleteTransaction(id);
        };

        window.setFilter = (key, value) => {
            state.filters[key] = value;
            render();
        };

        window.exportCSV = () => {
            // Re-calculate filtered data for export
            const filteredData = state.transactions.filter(t => {
                const tDate = t.date?.toDate ? t.date.toDate() : new Date(t.date);
                const start = new Date(state.filters.startDate);
                const end = new Date(state.filters.endDate);
                end.setHours(23, 59, 59);
                const dateMatch = tDate >= start && tDate <= end;
                const typeMatch = state.filters.type === 'all' || t.type === state.filters.type;
                return dateMatch && typeMatch;
            });
            generateCSV(filteredData);
        };

        // --- Initialization ---

        async function init() {
            render(); // Initial Loading State

            // Auth
            if (typeof window.__initial_auth_token !== 'undefined' && window.__initial_auth_token) {
                await signInWithCustomToken(auth, window.__initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (user) => {
                state.user = user;
                if (user) {
                    // Data Listener
                    const q = query(
                        collection(db, 'artifacts', appId, 'public', 'data', 'school_finance_transactions'),
                        orderBy('date', 'desc')
                    );
                    
                    onSnapshot(q, (snapshot) => {
                        state.transactions = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        render();
                    }, (error) => console.error(error));
                } else {
                    render();
                }
            });
        }

        init();

    </script>
</body>
</html>
